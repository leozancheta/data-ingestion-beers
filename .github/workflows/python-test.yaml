name: Run Unit Tests and Create PR

on:
  push:
    branches:
      - 'feature/**'
      - 'feature/*'
      - develop  # Adicionado para disparar quando hÃ¡ push em develop
  pull_request:
    branches:
      - 'develop'
      - 'main'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd brewery_pipeline
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt

      - name: Run unit tests
        run: |
          cd brewery_pipeline
          python -m pytest tests/ -v --tb=short

  create-pr:
    needs: test
    runs-on: ubuntu-latest
    if: success() && startsWith(github.ref, 'refs/heads/feature/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract branch name
        shell: bash
        run: echo "BRANCH_NAME=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_ENV

      - name: Check if PR already exists
        id: check_pr
        run: |
          PR_EXISTS=$(gh pr list --head ${{ env.BRANCH_NAME }} --base develop --json number --jq length)
          echo "PR_EXISTS=$PR_EXISTS" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        if: steps.check_pr.outputs.PR_EXISTS == '0'
        run: |
          gh pr create \
            --title "ğŸš€ Auto PR: ${{ env.BRANCH_NAME }} â†’ develop" \
            --body "## ğŸ“‹ Resumo das AlteraÃ§Ãµes

          Esta PR foi criada automaticamente apÃ³s os testes unitÃ¡rios passarem com sucesso.

          ### âœ… Testes Executados
          - Todos os testes unitÃ¡rios passaram
          - Pipeline de CI/CD validado

          ### ğŸ” Branch
          - **Origem**: \`${{ env.BRANCH_NAME }}\`
          - **Destino**: \`develop\`

          ### ğŸ“ PrÃ³ximos Passos
          1. Revisar as alteraÃ§Ãµes
          2. Verificar se nÃ£o hÃ¡ conflitos
          3. Fazer merge quando aprovado

          ---
          *Esta PR foi gerada automaticamente pelo GitHub Actions* ğŸ¤–" \
            --base develop \
            --head ${{ env.BRANCH_NAME }} \
            --assignee ${{ github.actor }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add labels to PR
        if: steps.check_pr.outputs.PR_EXISTS == '0'
        run: |
          PR_NUMBER=$(gh pr list --head ${{ env.BRANCH_NAME }} --base develop --json number --jq '.[0].number')
          
          # Tentar adicionar labels bÃ¡sicas que existem por padrÃ£o
          gh pr edit $PR_NUMBER --add-label "enhancement" || echo "Label enhancement nÃ£o encontrada"
          
          # Adicionar comentÃ¡rio informativo sobre o status
          gh pr comment $PR_NUMBER --body "ğŸ¤– **PR AutomÃ¡tica Criada**
          
          âœ… **Status**: Todos os testes unitÃ¡rios passaram
          ğŸ• **Criada em**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          ğŸ”§ **Tipo**: Automated PR apÃ³s testes bem-sucedidos
          
          Esta PR estÃ¡ pronta para revisÃ£o!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on existing PR
        if: steps.check_pr.outputs.PR_EXISTS != '0'
        run: |
          PR_NUMBER=$(gh pr list --head ${{ env.BRANCH_NAME }} --base develop --json number --jq '.[0].number')
          gh pr comment $PR_NUMBER --body "âœ… **Testes atualizados passaram com sucesso!**

          - Pipeline executado em: \`$(date)\`
          - Commit: \`${{ github.sha }}\`
          - Todos os testes unitÃ¡rios foram executados com sucesso"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trigger-release:
    needs: test
    runs-on: ubuntu-latest
    if: success() && github.ref == 'refs/heads/develop'
    
    steps:
      - name: Notify release workflow trigger
        run: |
          echo "ğŸš€ Pipeline em develop executado com sucesso!"
          echo "ğŸ“‹ O workflow de release (develop â†’ main) serÃ¡ disparado automaticamente"
          echo "ğŸ”„ Verificando se hÃ¡ mudanÃ§as para criar PR de release..."