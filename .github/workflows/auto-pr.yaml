name: Auto PR Creation

on:
  workflow_run:
    workflows: ["Run Unit Tests and Create PR"]
    types:
      - completed
    branches:
      - 'feature/**'

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Extract branch info
        shell: bash
        run: |
          echo "BRANCH_NAME=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_ENV
          echo "COMMIT_SHA=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV

      - name: Check if develop branch exists
        run: |
          if git show-ref --verify --quiet refs/remotes/origin/develop; then
            echo "DEVELOP_EXISTS=true" >> $GITHUB_ENV
          else
            echo "DEVELOP_EXISTS=false" >> $GITHUB_ENV
            echo "Branch develop nÃ£o existe, usando main como base"
          fi

      - name: Set target branch
        run: |
          if [ "${{ env.DEVELOP_EXISTS }}" = "true" ]; then
            echo "TARGET_BRANCH=develop" >> $GITHUB_ENV
          else
            echo "TARGET_BRANCH=main" >> $GITHUB_ENV
          fi

      - name: Check if PR already exists
        id: check_pr
        run: |
          PR_EXISTS=$(gh pr list --head ${{ env.BRANCH_NAME }} --base ${{ env.TARGET_BRANCH }} --json number --jq length)
          echo "PR_EXISTS=$PR_EXISTS" >> $GITHUB_OUTPUT
          
          if [ "$PR_EXISTS" != "0" ]; then
            PR_NUMBER=$(gh pr list --head ${{ env.BRANCH_NAME }} --base ${{ env.TARGET_BRANCH }} --json number --jq '.[0].number')
            echo "EXISTING_PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get commit info
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s" ${{ env.COMMIT_SHA }})
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an" ${{ env.COMMIT_SHA }})
          echo "COMMIT_MESSAGE<<EOF" >> $GITHUB_ENV
          echo "$COMMIT_MESSAGE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=$COMMIT_AUTHOR" >> $GITHUB_ENV

      - name: Create Pull Request
        if: steps.check_pr.outputs.PR_EXISTS == '0'
        run: |
          gh pr create \
            --title "ğŸš€ Auto PR: ${{ env.BRANCH_NAME }} â†’ ${{ env.TARGET_BRANCH }}" \
            --body "## ğŸ“‹ Resumo das AlteraÃ§Ãµes

          Esta PR foi criada automaticamente apÃ³s os testes unitÃ¡rios passarem com sucesso.

          ### âœ… Status dos Testes
          - âœ… Todos os testes unitÃ¡rios passaram
          - âœ… Pipeline de CI/CD validado
          - âœ… CÃ³digo pronto para revisÃ£o

          ### ğŸ“ InformaÃ§Ãµes do Commit
          - **Ãšltimo commit**: \`${{ env.COMMIT_MESSAGE }}\`
          - **Autor**: ${{ env.COMMIT_AUTHOR }}
          - **SHA**: \`${{ env.COMMIT_SHA }}\`

          ### ğŸ” Detalhes da Branch
          - **Branch origem**: \`${{ env.BRANCH_NAME }}\`
          - **Branch destino**: \`${{ env.TARGET_BRANCH }}\`
          - **Workflow**: [Ver execuÃ§Ã£o](${{ github.event.workflow_run.html_url }})

          ### ğŸ“‹ Checklist para RevisÃ£o
          - [ ] CÃ³digo revisado
          - [ ] Testes adicionais necessÃ¡rios?
          - [ ] DocumentaÃ§Ã£o atualizada?
          - [ ] Sem conflitos de merge

          ### ğŸš€ PrÃ³ximos Passos
          1. ğŸ‘€ Revisar as alteraÃ§Ãµes
          2. âœ… Aprovar se estiver tudo ok
          3. ğŸ”€ Fazer merge quando aprovado

          ---
          *Esta PR foi gerada automaticamente pelo GitHub Actions* ğŸ¤–
          
          **NÃ£o fazer merge automaticamente** - Aguardar revisÃ£o manual." \
            --base ${{ env.TARGET_BRANCH }} \
            --head ${{ env.BRANCH_NAME }} \
            --assignee ${{ github.event.workflow_run.actor.login }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add labels and reviewers to new PR
        if: steps.check_pr.outputs.PR_EXISTS == '0'
        run: |
          # Aguardar um pouco para a PR ser criada
          sleep 5
          
          PR_NUMBER=$(gh pr list --head ${{ env.BRANCH_NAME }} --base ${{ env.TARGET_BRANCH }} --json number --jq '.[0].number')
          
          # Tentar adicionar labels bÃ¡sicas que existem por padrÃ£o
          gh pr edit $PR_NUMBER --add-label "enhancement" || echo "Label enhancement nÃ£o encontrada"
          
          # Adicionar comentÃ¡rio informativo sobre o status automÃ¡tico
          gh pr comment $PR_NUMBER --body "ğŸ¤– **Status AutomÃ¡tico da PR**
          
          âœ… **Testes**: Todos passaram com sucesso
          ğŸ”„ **Tipo**: PR automÃ¡tica pÃ³s-validaÃ§Ã£o
          ğŸ“ **AÃ§Ã£o**: Pronta para revisÃ£o manual
          ğŸš€ **PrÃ³ximo passo**: Aguardando aprovaÃ§Ã£o para merge"
          
          echo "âœ… PR #$PR_NUMBER criada com sucesso!"
          echo "ğŸ”— Link: ${{ github.server_url }}/${{ github.repository }}/pull/$PR_NUMBER"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update existing PR
        if: steps.check_pr.outputs.PR_EXISTS != '0'
        run: |
          PR_NUMBER=${{ steps.check_pr.outputs.EXISTING_PR_NUMBER }}
          
          gh pr comment $PR_NUMBER --body "ğŸ”„ **AtualizaÃ§Ã£o da Branch - Testes Passaram!**

          ### âœ… Status Atual
          - âœ… Todos os testes unitÃ¡rios passaram novamente
          - ğŸ• Executado em: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - ğŸ“¦ Novo commit: \`${{ env.COMMIT_SHA }}\`

          ### ğŸ“ Ãšltimo Commit
          - **Mensagem**: ${{ env.COMMIT_MESSAGE }}
          - **Autor**: ${{ env.COMMIT_AUTHOR }}

          ### ğŸ”— Links Ãšteis
          - [Ver workflow](${{ github.event.workflow_run.html_url }})
          - [Ver commit]({{ github.server_url }}/${{ github.repository }}/commit/${{ env.COMMIT_SHA }})

          A PR estÃ¡ atualizada e pronta para revisÃ£o! ğŸš€"
          
          echo "âœ… PR #$PR_NUMBER atualizada com sucesso!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
