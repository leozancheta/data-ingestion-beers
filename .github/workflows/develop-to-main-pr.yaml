name: Auto PR Develop to Main

on:
  push:
    branches:
      - develop
  workflow_run:
    workflows: ["Run Unit Tests and Create PR"]
    types:
      - completed
    branches:
      - develop

jobs:
  create-pr-to-main:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: develop

      - name: Check if main branch exists
        run: |
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            echo "MAIN_EXISTS=true" >> $GITHUB_ENV
          else
            echo "MAIN_EXISTS=false" >> $GITHUB_ENV
            echo "Branch main nÃ£o existe, cancelando workflow"
            exit 1
          fi

      - name: Check for differences between develop and main
        id: check_diff
        run: |
          # Buscar as Ãºltimas mudanÃ§as
          git fetch origin main develop
          
          # Verificar se hÃ¡ diferenÃ§as entre develop e main
          DIFF_COUNT=$(git rev-list --count origin/main..origin/develop)
          echo "DIFF_COUNT=$DIFF_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$DIFF_COUNT" -eq "0" ]; then
            echo "NÃ£o hÃ¡ diferenÃ§as entre develop e main"
            echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
          else
            echo "Encontradas $DIFF_COUNT diferenÃ§as entre develop e main"
            echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
          fi

      - name: Check if PR already exists
        id: check_pr
        if: steps.check_diff.outputs.HAS_CHANGES == 'true'
        run: |
          PR_EXISTS=$(gh pr list --head develop --base main --json number --jq length)
          echo "PR_EXISTS=$PR_EXISTS" >> $GITHUB_OUTPUT
          
          if [ "$PR_EXISTS" != "0" ]; then
            PR_NUMBER=$(gh pr list --head develop --base main --json number --jq '.[0].number')
            echo "EXISTING_PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest commits info
        if: steps.check_diff.outputs.HAS_CHANGES == 'true'
        run: |
          # Pegar informaÃ§Ãµes dos Ãºltimos commits em develop
          LAST_COMMITS=$(git log origin/main..origin/develop --oneline --max-count=10)
          echo "LAST_COMMITS<<EOF" >> $GITHUB_ENV
          echo "$LAST_COMMITS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # Pegar o Ãºltimo commit
          LAST_COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s" origin/develop)
          LAST_COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an" origin/develop)
          echo "LAST_COMMIT_MESSAGE<<EOF" >> $GITHUB_ENV
          echo "$LAST_COMMIT_MESSAGE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "LAST_COMMIT_AUTHOR=$LAST_COMMIT_AUTHOR" >> $GITHUB_ENV

      - name: Create Pull Request from develop to main
        if: steps.check_diff.outputs.HAS_CHANGES == 'true' && steps.check_pr.outputs.PR_EXISTS == '0'
        run: |
          gh pr create \
            --title "ğŸš€ Release: develop â†’ main" \
            --body "## ğŸ“‹ Release Notes - Develop para Main

          Esta PR foi criada automaticamente para sincronizar as mudanÃ§as de \`develop\` para \`main\`.

          ### âœ… Status dos Testes
          - âœ… Todos os testes unitÃ¡rios passaram em develop
          - âœ… Pipeline de CI/CD validado
          - âœ… Features validadas e aprovadas

          ### ğŸ“ Ãšltimas MudanÃ§as
          \`\`\`
          ${{ env.LAST_COMMITS }}
          \`\`\`

          ### ğŸ” InformaÃ§Ãµes da Release
          - **Branch origem**: \`develop\`
          - **Branch destino**: \`main\`
          - **Ãšltimo commit**: \`${{ env.LAST_COMMIT_MESSAGE }}\`
          - **Autor**: ${{ env.LAST_COMMIT_AUTHOR }}
          - **Data**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ### ğŸ“‹ Checklist para Release
          - [ ] CÃ³digo revisado e aprovado em develop
          - [ ] Todos os testes passando
          - [ ] DocumentaÃ§Ã£o atualizada se necessÃ¡rio
          - [ ] VersÃ£o/changelog atualizado (se aplicÃ¡vel)
          - [ ] Sem breaking changes nÃ£o documentadas

          ### ğŸš€ PrÃ³ximos Passos
          1. ğŸ‘€ Revisar as mudanÃ§as consolidadas
          2. âœ… Aprovar se tudo estiver correto
          3. ğŸ”€ Fazer merge para main (release)
          4. ğŸ·ï¸ Criar tag de versÃ£o se necessÃ¡rio

          ---
          *Esta PR foi gerada automaticamente pelo GitHub Actions* ğŸ¤–
          
          **âš ï¸ IMPORTANTE**: Esta Ã© uma release para produÃ§Ã£o - revisar cuidadosamente antes do merge!" \
            --base main \
            --head develop \
            --assignee ${{ github.actor }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add labels and reviewers to new PR
        if: steps.check_diff.outputs.HAS_CHANGES == 'true' && steps.check_pr.outputs.PR_EXISTS == '0'
        run: |
          # Aguardar um pouco para a PR ser criada
          sleep 5
          
          PR_NUMBER=$(gh pr list --head develop --base main --json number --jq '.[0].number')
          
          # Tentar adicionar labels de release
          gh pr edit $PR_NUMBER --add-label "release" || echo "Label release nÃ£o encontrada"
          gh pr edit $PR_NUMBER --add-label "enhancement" || echo "Label enhancement nÃ£o encontrada"
          
          # Adicionar comentÃ¡rio informativo sobre a release
          gh pr comment $PR_NUMBER --body "ğŸš€ **Release AutomÃ¡tica - Develop â†’ Main**
          
          ### ğŸ“Š EstatÃ­sticas
          - ğŸ”„ **Commits novos**: ${{ steps.check_diff.outputs.DIFF_COUNT }}
          - ğŸ• **Criada em**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - ğŸ·ï¸ **Tipo**: Release automÃ¡tica
          
          ### âš ï¸ AtenÃ§Ã£o
          Esta Ã© uma PR de **release para produÃ§Ã£o**. Por favor:
          - Revisar todas as mudanÃ§as cuidadosamente
          - Verificar se hÃ¡ breaking changes
          - Confirmar que todos os testes passaram
          - Validar se a documentaÃ§Ã£o estÃ¡ atualizada
          
          ### ğŸ”„ Workflow
          1. Esta PR foi criada automaticamente apÃ³s mudanÃ§as em develop
          2. Aguardando revisÃ£o manual antes do merge
          3. ApÃ³s aprovaÃ§Ã£o, serÃ¡ feito o merge para main
          
          **NÃ£o fazer merge sem revisÃ£o adequada!** ğŸš¨"
          
          echo "âœ… PR #$PR_NUMBER criada com sucesso!"
          echo "ğŸ”— Link: ${{ github.server_url }}/${{ github.repository }}/pull/$PR_NUMBER"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update existing PR
        if: steps.check_diff.outputs.HAS_CHANGES == 'true' && steps.check_pr.outputs.PR_EXISTS != '0'
        run: |
          PR_NUMBER=${{ steps.check_pr.outputs.EXISTING_PR_NUMBER }}
          
          gh pr comment $PR_NUMBER --body "ğŸ”„ **Release Atualizada - Novas MudanÃ§as em Develop**

          ### âœ… Status Atual
          - âœ… Novas mudanÃ§as detectadas em develop
          - ğŸ• Atualizado em: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - ğŸ“¦ Novos commits: ${{ steps.check_diff.outputs.DIFF_COUNT }}

          ### ğŸ“ Ãšltimas MudanÃ§as
          \`\`\`
          ${{ env.LAST_COMMITS }}
          \`\`\`

          ### ğŸ” Ãšltimo Commit
          - **Mensagem**: ${{ env.LAST_COMMIT_MESSAGE }}
          - **Autor**: ${{ env.LAST_COMMIT_AUTHOR }}

          ### ğŸ”— Links Ãšteis
          - [Ver workflow](${{ github.server_url }}/${{ github.repository }}/actions)
          - [Comparar mudanÃ§as](${{ github.server_url }}/${{ github.repository }}/compare/main...develop)

          A PR foi atualizada e estÃ¡ pronta para nova revisÃ£o! ğŸš€"
          
          echo "âœ… PR #$PR_NUMBER atualizada com sucesso!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: No changes detected
        if: steps.check_diff.outputs.HAS_CHANGES == 'false'
        run: |
          echo "â„¹ï¸ Nenhuma mudanÃ§a detectada entre develop e main"
          echo "NÃ£o hÃ¡ necessidade de criar uma PR de release"
